#!/usr/bin/env python3
import subprocess
import os
import sys
import tempfile

# HARDCODED
HOST = '100.1.1.1'
PORT = 37422
USER = 'c_X_logs'
PASS = 'your_password_here'
DIR = '/shared_Xlogs'

FILENAME = os.getenv('CRIBL_COLLECT_ARG')

# Create temp file in /tmp
temp_file = f"/tmp/cribl_sftp_{os.getpid()}.tmp"

try:
    # SFTP commands - download to temp file
    sftp_commands = f"""get {DIR}/{FILENAME} {temp_file}
bye
"""
    
    # Run SFTP
    subprocess.run(
        ['sshpass', '-p', PASS, 'sftp',
         '-q',
         f'-oPort={PORT}',
         '-oStrictHostKeyChecking=no',
         '-oBatchMode=no',
         f'{USER}@{HOST}'],
        input=sftp_commands.encode(),
        capture_output=True,
        check=True
    )
    
    # Read temp file and output to stdout
    with open(temp_file, 'rb') as f:
        sys.stdout.buffer.write(f.read())
    
except Exception as e:
    sys.stderr.write(f"Error: {e}\n")
    sys.exit(1)
    
finally:
    # Always clean up temp file
    if os.path.exists(temp_file):
        os.unlink(temp_file)
