#!/usr/bin/env python3
import subprocess
import os
import sys

# HARDCODED - Edit these values
HOST = '100.1.1.1'
PORT = 37422
USER = 'c_X_logs'
PASS = 'your_password_here'
DIR = '/shared_Xlogs'

# Get filename from Cribl
FILENAME = os.getenv('CRIBL_COLLECT_ARG')

# SFTP commands
sftp_commands = f"""get {DIR}/{FILENAME} -
bye
"""

# Run SFTP
result = subprocess.run(
    ['sshpass', '-p', PASS, 'sftp',
     '-q',
     f'-oPort={PORT}',
     '-oStrictHostKeyChecking=no',
     '-oBatchMode=no',
     f'{USER}@{HOST}'],
    input=sftp_commands.encode(),
    capture_output=True
)

# DEBUG: Show what we captured
sys.stderr.write("=== DEBUG STDOUT LENGTH ===\n")
sys.stderr.write(f"{len(result.stdout)} bytes\n")

sys.stderr.write("\n=== DEBUG STDOUT (first 500 chars) ===\n")
sys.stderr.write(repr(result.stdout[:500]))
sys.stderr.write("\n")

sys.stderr.write("\n=== DEBUG STDERR ===\n")
sys.stderr.write(result.stderr.decode('utf-8', errors='ignore'))
sys.stderr.write("\n")

# Output file contents to stdout
sys.stdout.buffer.write(result.stdout)
